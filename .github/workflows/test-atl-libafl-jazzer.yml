name: "[atl-libafl-jazzer] Team Atlanta Jazzer Testing"

on:
  workflow_dispatch:
  merge_group:
  pull_request:
    branches: [ "**" ]
    paths:
      - crs/fuzzers/atl-libafl-jazzer/**

jobs:
  atl-libafl-jazzer-build-n-test:
    runs-on: self-hosted
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.SSHKEY_GT_NOSGX_RSA }}
        submodules: 'recursive'
        lfs: false

    - name: Build atl-libafl-jazzer testing docker image
      run: |
        docker build \
          -t atl-libafl-jazzer-test:latest \
          -f misc/Dockerfile.atl-libafl-jazzer \
          .

        docker run \
          --rm \
          -w /app/crs-cp-java/fuzzers/atl-libafl-jazzer \
          -u builder:builder \
          atl-libafl-jazzer-test:latest \
          bash -c "bazel test //... --verbose_failures --flaky_test_attempts=3 --test_summary=detailed"
