# libFDP

libFDP is a codec provider for some well-known `FuzzedDataProvider` implementations.

## Installation

To use it in Rust projects, add it to the project dependencies:

```toml
[dependencies]
libfdp = { path = "path/to/libfdp" }
```

To use it in Python projects, run the following code to install Python FFI modules:

```bash
./build_pymodule.sh
```

## Usage

`libFDP` supports `FuzzedDataProvider` implemented by [`LLVM`](https://github.com/llvm/llvm-project/blob/main/compiler-rt/include/fuzzer/FuzzedDataProvider.h) and [`Jazzer`](https://github.com/CodeIntelligenceTesting/jazzer/blob/main/src/main/java/com/code_intelligence/jazzer/driver/FuzzedDataProviderImpl.java).

You can choose `LlvmFdpEncoder` for `LLVM` based implementation and `JazzerFdpEncoder` for `Jazzer` based implementation.
These encoders exposes one-to-one matched producer functions for your convenience.
For example, if you find `ConsumeChar` in the JVM harness fuzz loop, then you can utilize `produce_jchar` of `JazzerFdpEncoder`.

To get the encoded result, call `finalize`, and you will get the encoded byte array.

The following table is supported consumer functions of `FuzzedDataProvider`:

| Type   | Consumer                                                                                                                                    | Producer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Ready? |
|--------|---------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------|
| LLVM   | `ConsumeBytes(size_t num_bytes)`<br>`ConsumeData(void *destination, size_t num_bytes)`                                                      | `produce_bytes(value: bytes, num_bytes: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | ✅      |
| LLVM   | `ConsumeBytesWithTerminator(size_t num_bytes, T terminator)`                                                                                | `produce_bytes_with_terminator(value: bytes, num_bytes: int, terminator: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                            | ✅      |
| LLVM   | `ConsumeRemainingBytes()`                                                                                                                   | `produce_remaining_bytes(value: bytes)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ✅      |
| LLVM   | `ConsumeBytesAsString(size_t num_bytes)`                                                                                                    | `produce_bytes_as_string(value: str, num_bytes: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | ✅      |
| LLVM   | `ConsumeRandomLengthString(size_t max_length)`                                                                                              | `produce_random_length_string_with_max_length(value: str, max_length: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                               | ✅      |
| LLVM   | `ConsumeRandomLengthString()`                                                                                                               | `produce_random_length_string(value: str)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | ✅      |
| LLVM   | `ConsumeRemainingBytesAsString()`                                                                                                           | `produce_remaining_bytes_as_string(value: str)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | ✅      |
| LLVM   | `ConsumeIntegral()`                                                                                                                         | `produce_byte(value: int)`<br>`produce_char(value: int)`<br>`produce_short(value: int)`<br>`produce_unsigned_short(value: int)`<br>`produce_int(value: int)`<br>`produce_unsigned_int(value: int)`<br>`produce_long_long(value: int)`<br>`produce_unsigned_long_long(value: int)`                                                                                                                                                                                                                                         | ✅      |
| LLVM   | `ConsumeIntegralInRange(T min, T max)`                                                                                                      | `produce_byte_in_range(value: int, min: int, max: int)`<br>`produce_char_in_range(value: int, min: int, max: int)`<br>`produce_short_in_range(value: int, min: int, max: int)`<br>`produce_unsigned_short_in_range(value: int, min: int, max: int)`<br>`produce_int_in_range(value: int, min: int, max: int)`<br>`produce_unsigned_int_in_range(value: int, min: int, max: int)`<br>`produce_long_long_in_range(value: int, min: int, max: int)`<br>`produce_unsigned_long_long_in_range(value: int, min: int, max: int)` | ✅      |
| LLVM   | `ConsumeFloatingPoint()`                                                                                                                    | `produce_float(value: float)`<br>`produce_double(value: float)`                                                                                                                                                                                                                                                                                                                                                                                                                                                           | ✅      |
| LLVM   | `ConsumeFloatingPointInRange(T min, T max)`                                                                                                 | `produce_float_in_range(value: float, min: float, max: float)`<br>`produce_double_in_range(value: float, min: float, max: float)`                                                                                                                                                                                                                                                                                                                                                                                         | ✅      |
| LLVM   | `ConsumeProbability()`                                                                                                                      | `produce_probability_float(value: float)`<br>`produce_probability_double(value: float)`                                                                                                                                                                                                                                                                                                                                                                                                                                   | ✅      |
| LLVM   | `ConsumeBool()`                                                                                                                             | `produce_bool(value: bool)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | ✅      |
| LLVM   | `ConsumeEnum()`                                                                                                                             | `produce_enum(value: int, num_variants: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | ✅      |
| LLVM   | `PickValueInArray(const T (&array)[size])`<br>`PickValueInArray(const std::array &array)`<br>`PickValueInArray(std::initializer_list list)` | `produce_picked_value_index_in_array(value: int, array_size: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                        | ✅      |
| LLVM   | `remaining_bytes()`                                                                                                                         | `mark_remaining_bytes(value: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | ✅      |
| Jazzer | `consumeByte(byte min, byte max)`                                                                                                           | `produce_jbyte_in_range(value: int, min: int, max: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | ✅      |
| Jazzer | `consumeShort(short min, short max)`                                                                                                        | `produce_jshort_in_range(value: int, min: int, max: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | ✅      |
| Jazzer | `consumeChar(char min, char max)`                                                                                                           | `produce_jchar_in_range(value: int, min: int, max: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | ✅      |
| Jazzer | `consumeInt(int min, int max)`                                                                                                              | `produce_jint_in_range(value: int, min: int, max: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ✅      |
| Jazzer | `consumeLong(long min, long max)`                                                                                                           | `produce_jlong_in_range(value: int, min: int, max: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | ✅      |
| Jazzer | `consumeByte()`                                                                                                                             | `produce_jbyte(value: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | ✅      |
| Jazzer | `consumeShort()`                                                                                                                            | `produce_jshort(value: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | ✅      |
| Jazzer | `consumeInt()`                                                                                                                              | `produce_jint(value: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | ✅      |
| Jazzer | `consumeLong()`                                                                                                                             | `produce_jlong(value: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | ✅      |
| Jazzer | `consumeBoolean()`                                                                                                                          | `produce_jbool(value: bool)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | ✅      |
| Jazzer | `consumeChar()`<br>`consumeCharNoSurrogates()`                                                                                              | `produce_jchar(value: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | ✅      |
| Jazzer | `consumeProbabilityFloat()`                                                                                                                 | `produce_probability_jfloat(value: float)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | ✅      |
| Jazzer | `consumeProbabilityDouble()`                                                                                                                | `produce_probability_jdouble(value: float)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | ✅      |
| Jazzer | `consumeRegularFloat(float min, float max)`                                                                                                 | `produce_regular_jfloat_in_range(value: float, min: float, max: float)`                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ✅      |
| Jazzer | `consumeRegularDouble(double min, double max)`                                                                                              | `produce_regular_jdouble_in_range(value: float, min: float, max: float)`                                                                                                                                                                                                                                                                                                                                                                                                                                                  | ✅      |
| Jazzer | `consumeRegularFloat()`                                                                                                                     | `produce_regular_jfloat(value: float)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | ✅      |
| Jazzer | `consumeRegularDouble()`                                                                                                                    | `produce_regular_jdouble(value: float)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ✅      |
| Jazzer | `consumeFloat()`                                                                                                                            | `produce_jfloat(value: float)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | ✅      |
| Jazzer | `consumeDouble()`                                                                                                                           | `produce_jdouble(value: float)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | ✅      |
| Jazzer | `consumeBooleans(int maxLength)`                                                                                                            | `produce_jbools(value: List[bool], maxLength: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | ✅      |
| Jazzer | `consumeBytes(int maxLength)`                                                                                                               | `produce_jbytes(value: bytes, maxLength: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | ✅      |
| Jazzer | `consumeShorts(int maxLength)`                                                                                                              | `produce_jshorts(value: List[int], maxLength: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | ✅      |
| Jazzer | `consumeInts(int maxLength)`                                                                                                                | `produce_jints(value: List[int], maxLength: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | ✅      |
| Jazzer | `consumeLongs(int maxLength)`                                                                                                               | `produce_jlongs(value: List[int], maxLength: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | ✅      |
| Jazzer | `consumeRemainingAsBytes()`                                                                                                                 | `produce_remaining_as_jbytes(value: bytes)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | ✅      |
| Jazzer | `consumeAsciiString(int maxLength)`                                                                                                         | `produce_ascii_string(value: str, maxLength: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | ✅      |
| Jazzer | `consumeRemainingAsAsciiString()`                                                                                                           | `produce_remaining_as_ascii_string(value: str)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | ✅      |
| Jazzer | `consumeString(int maxLength)`                                                                                                              | `produce_jstring(value: str, maxLength: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | ✅      |
| Jazzer | `consumeRemainingAsString()`                                                                                                                | `produce_remaining_as_jstring(value: str)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | ✅      |
| Jazzer | `remainingBytes()`                                                                                                                          | `mark_remaining_bytes(value: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | ✅      |
| Jazzer | `pickValue(Collection collection)`<br>`pickValue(T[] array)`                                                                                | `produce_picked_value_index_in_jarray(value: int, length: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                           | ✅      |
| Jazzer | `pickValues(Collection collection, int numOfElements)`<br>`pickValues(T[] array, int numOfElements)`                                        | `produce_picked_value_indexes_in_jarray(value: List[int], length: int)`                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ✅      |

### Using encoder in Python

```python
import libfdp
jazzer_encoder = libfdp.JazzerFdpEncoder()
jazzer_encoder.produce_jint_in_range(3, 0, 256)
print(jazzer_encoder.finalize())
```

### Using low-level encoder

If you desire to control the encoder in low-level, you may use `FdpEncoder` instead. (Supporting Rust only, yet.)

### Unchecked encoder functions

Unchecked encoder function is provided as encoding procedure is indeterministic due to the nature of FDP reference implementations.
They are named with its corresponding function name followed by `_unchecked`.
Unchecked encoder functions don't consider the state of the encoder. Which means that you can override strong constraints applied to the encoder.
For instance, in Jazzer, string related FDP functions have irreversible procedure, so the constraint check after that function may fail even though it is legal.
In this case, as a fallback, you can use unchecked functions to complete the encoding process.

## Caveats

### `FuzzedDataProvider` decodes deterministically, but it doesn't hold when encoding (unfixable)

As some information is lost while decoding (e.g., `ConsumeString`, `ConsumeCharNoSurrogates`), `libFDP` cannot guarantee that the encoded result match the original one.

In the codec sequence:
`ORIGINAL_BLOB -> (DECODER) -> FDP_SEQUENCE_1 -> (ENCODER) -> IMITATED_BLOB -> (DECODER) -> FDP_SEQUENCE_2`,
`libFDP` aims to meet `FDP_SEQUENCE_1 == FDP_SEQUENCE_2` but not `ORIGINAL_BLOB == IMITATED_BLOB`.

### Floating point encoding may produce different value depending on CP build options or platform (unfixable)

Floating point arithmetics may produce different output if architecture/runtime/etc. is different.

### FDP doesn't support all representable floating points (unfixable)

Note that due to the nature of the implementation of floating point operations of FDP,
it doesn't cover all possible representable floating points.
It is guaranteed to support properly "consumed" floating points, but not bit-wise randomly generated or calculated values.

### libFDP's checked APIs may determine some legal sequences as invalid (unfixable)

As some encoding requests such as string operations are indeterministic, libFDP can rarely reject some legal FDP sequences.
In this case it is recommended to use unchecked APIs.

## License

Licensed under the MIT license.

The unmodified part of the code in `fdp-reference/src/cpp/FuzzedDataProvider.h`
is originally licensed under the Apache License v2.0 with LLVM Exceptions. See
the file for more details.

Some part of the code in `fdp-reference/src/cpp/fdp_jazzer.cpp` is originally
licensed under the Apache License v2.0. See the file for more details.
